{% extends 'restaurant/base.html' %}
{% load custom_filters %}

{% block title %}Order Details{% endblock %}

{% block content %}
{% load static %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
<style>
    body, .order-detail-container {
        background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
        min-height: 100vh;
    }
    .order-detail-container {
        max-width: 1100px;
        margin: 2rem auto;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 4px 32px 0 rgba(0, 0, 0, 0.10);
        padding: 2rem 1.5rem;
    }
    .order-header-section {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        border-bottom: 2px solid #00bcd4;
        padding-bottom: 1rem;
    }
    .order-header-section h1 {
        font-size: 2.2rem;
        color: #00838f;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.7rem;
    }
    .order-id-badge {
        background: linear-gradient(90deg, #00bcd4 60%, #1976d2 100%);
        color: #fff;
        font-weight: 600;
        border-radius: 8px;
        padding: 0.5rem 1.2rem;
        font-size: 1.1rem;
        box-shadow: 0 2px 8px 0 rgba(0,188,212,0.10);
    }
    .order-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.2rem;
        margin-bottom: 2rem;
    }
    .info-card {
        background: #e3f2fd;
        border-radius: 12px;
        padding: 1.1rem 1rem 0.8rem 1rem;
        box-shadow: 0 2px 8px 0 rgba(33,150,243,0.07);
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        min-height: 110px;
    }
    .info-card-title {
        font-size: 1.1rem;
        color: #0288d1;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .info-card-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: #006064;
    }
    .info-card-meta {
        font-size: 0.98rem;
        color: #607d8b;
        margin-top: 0.1rem;
    }
    .status-badge {
        display: inline-block;
        padding: 0.3rem 0.9rem;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: 600;
        margin-top: 0.2rem;
    }
    .status-badge.pending { background: #fffde7; color: #fbc02d; border: 1px solid #ffe082; }
    .status-badge.completed { background: #e8f5e9; color: #388e3c; border: 1px solid #a5d6a7; }
    .status-badge.cancelled { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }
    .status-badge.paid { background: #e0f2f1; color: #00796b; border: 1px solid #b2dfdb; }
    .status-badge.unpaid { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
    .content-card {
        background: #f5fafd;
        border-radius: 14px;
        box-shadow: 0 2px 8px 0 rgba(0,188,212,0.07);
        margin-bottom: 2rem;
        padding: 1.2rem 1.1rem 1.1rem 1.1rem;
    }
    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }
    .card-header h2 {
        font-size: 1.3rem;
        color: #00838f;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }
    .items-table {
        width: 100%;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 1.2rem;
        box-shadow: 0 1px 4px 0 rgba(33,150,243,0.04);
    }
    .items-table th, .items-table td {
        padding: 0.7rem 0.6rem;
        text-align: left;
        font-size: 1rem;
    }
    .items-table th {
        background: #00bcd4;
        color: #fff;
        font-weight: 600;
        border-bottom: 2px solid #b2ebf2;
    }
    .items-table td {
        border-bottom: 1px solid #e0e0e0;
    }
    .items-table tr:last-child td {
        border-bottom: none;
    }
    .summary-section {
        margin-top: 1.2rem;
        background: #e0f7fa;
        border-radius: 8px;
        padding: 0.8rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-width: 350px;
    }
    .summary-row {
        display: flex;
        justify-content: space-between;
        font-size: 1.05rem;
    }
    .summary-row.total {
        font-weight: 700;
        color: #00838f;
        font-size: 1.15rem;
    }
    .empty-state {
        text-align: center;
        color: #b0bec5;
        padding: 2rem 0 1rem 0;
    }
    .empty-state-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    .payment-item {
        background: #e3f2fd;
        border-radius: 8px;
        padding: 0.8rem 1rem;
        margin-bottom: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 1px 4px 0 rgba(33,150,243,0.04);
    }
    .payment-item-header {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }
    .payment-method {
        font-weight: 600;
        color: #0288d1;
    }
    .payment-amount {
        font-size: 1.1rem;
        font-weight: 700;
        color: #006064;
    }
    .payment-actions .btn {
        margin-left: 0.5rem;
    }
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 2rem;
        justify-content: flex-end;
    }
    .modal-backdrop {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0, 188, 212, 0.13);
        z-index: 1050;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }
    .modal-backdrop.active {
        display: flex;
    }
    .modal-content {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 8px 32px 0 rgba(0,188,212,0.18);
        padding: 2rem 1.5rem 1.5rem 1.5rem;
        min-width: 320px;
        max-width: 95vw;
        animation: slideInUp 0.3s;
        position: relative;
    }
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.2rem;
    }
    .modal-header h3 {
        font-size: 1.3rem;
        color: #00838f;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }
    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #00bcd4;
        cursor: pointer;
        font-weight: 700;
        line-height: 1;
    }
    .modal-footer {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.2rem;
    }
    .form-group {
        margin-bottom: 1.1rem;
    }
    .form-label {
        font-weight: 600;
        color: #0288d1;
        margin-bottom: 0.3rem;
    }
    .form-control {
        border-radius: 7px;
        border: 1px solid #b2ebf2;
        font-size: 1rem;
        padding: 0.6rem 0.9rem;
    }
    .btn-primary {
        background: linear-gradient(90deg, #00bcd4 60%, #1976d2 100%);
        border: none;
        color: #fff;
        font-weight: 600;
        box-shadow: 0 2px 8px 0 rgba(0,188,212,0.10);
    }
    .btn-success {
        background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
        border: none;
        color: #fff;
        font-weight: 600;
        box-shadow: 0 2px 8px 0 rgba(67,233,123,0.10);
    }
    .btn-danger {
        background: linear-gradient(90deg, #ff5858 0%, #f09819 100%);
        border: none;
        color: #fff;
        font-weight: 600;
        box-shadow: 0 2px 8px 0 rgba(255,88,88,0.10);
    }
    .btn-secondary {
        background: #b2ebf2;
        color: #006064;
        font-weight: 600;
        border: none;
    }
    .btn-info {
        background: linear-gradient(90deg, #2196f3 0%, #21cbf3 100%);
        color: #fff;
        font-weight: 600;
        border: none;
    }
    .btn {
        border-radius: 7px;
        padding: 0.5rem 1.1rem;
        font-size: 1rem;
        transition: box-shadow 0.2s, background 0.2s;
    }
    .btn:active, .btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px #00bcd4;
    }
    @media (max-width: 900px) {
        .order-detail-container {
            padding: 1.2rem 0.3rem;
        }
        .order-header-section {
            flex-direction: column;
            gap: 0.7rem;
        }
        .order-info-grid {
            grid-template-columns: 1fr 1fr;
        }
    }
    @media (max-width: 600px) {
        .order-info-grid {
            grid-template-columns: 1fr;
        }
        .order-header-section h1 {
            font-size: 1.3rem;
        }
        .order-id-badge {
            font-size: 0.95rem;
        }
        .content-card, .modal-content {
            padding: 1rem 0.5rem;
        }
        .summary-section {
            max-width: 100%;
        }
    }
</style>

    .status-badge.pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-badge.completed {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-badge.cancelled {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .status-badge.paid {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-badge.unpaid {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .content-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .card-header {
        background: #f8f9fa;
        padding: 1.5rem;
        border-bottom: 2px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-header h2 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 700;
        color: #212529;
    }

    .card-body {
        padding: 1.5rem;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
    }

    .items-table thead {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .items-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 700;
        color: #495057;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .items-table td {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .items-table tbody tr {
        transition: background-color 0.2s ease;
    }

    .items-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .item-name {
        font-weight: 600;
        color: #212529;
    }

    .item-qty {
        text-align: center;
        font-weight: 600;
    }

    .item-price {
        text-align: right;
        color: #0d6efd;
        font-weight: 600;
    }

    .item-total {
        text-align: right;
        color: #0d6efd;
        font-weight: 700;
    }

    .summary-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        border-left: 4px solid #0d6efd;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        font-size: 1rem;
    }

    .summary-row.total {
        border-top: 2px solid #dee2e6;
        padding-top: 1rem;
        margin-top: 1rem;
        font-size: 1.3rem;
        font-weight: 700;
        color: #0d6efd;
    }

    .payment-item {
        background: #f8f9fa;
        padding: 1.2rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #28a745;
        transition: all 0.3s ease;
        animation: slideIn 0.3s ease;
    }

    .payment-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
    }

    .payment-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .payment-method {
        font-weight: 700;
        color: #212529;
    }

    .payment-amount {
        font-size: 1.2rem;
        font-weight: 700;
        color: #28a745;
    }

    .payment-actions {
        display: flex;
        gap: 0.75rem;
    }

    .payment-actions button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.85rem;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 2rem;
    }

    .action-buttons .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 150px;
    }

    .action-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
        background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
        color: white;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        color: white;
    }

    .btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #0c5460 100%);
        color: white;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9998;
    }

    .modal-backdrop.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 2px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 700;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 1rem;
        transition: all 0.3s ease;
        font-family: inherit;
    }

    .form-control:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .btn-close {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.5rem;
        padding: 0;
    }

    @media (max-width: 768px) {
        .order-detail-container {
            padding: 1rem;
        }

        .order-header-section {
            padding: 1.5rem;
        }

        .order-info-grid {
            grid-template-columns: 1fr;
        }

        .card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .items-table {
            font-size: 0.9rem;
        }

        .items-table th,
        .items-table td {
            padding: 0.75rem 0.5rem;
        }

        .action-buttons {
            flex-direction: column;
        }

        .action-buttons .btn {
            width: 100%;
        }
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .toast {
        position: fixed;
        bottom: 2rem;
        right: 1rem;
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideInUp 0.3s ease;
        z-index: 9999;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<div class="order-detail-container shadow-lg">
    <!-- Header Section -->
    <div class="order-header-section">
        <h1>
            <i class="fas fa-receipt"></i>Order Details
        </h1>
        <div class="order-id-badge">
            Order #{{ order.order_id }}
        </div>
    </div>

    <!-- Info Cards Grid -->
    <div class="order-info-grid">
        <!-- Customer Info -->
        <div class="info-card">
            <div class="info-card-title">
                <i class="fas fa-user"></i>Customer
            </div>
            <div class="info-card-value">{{ order.customer_name }}</div>
            <div class="info-card-meta">
                <i class="fas fa-phone"></i> {{ order.customer_phone }}
            </div>
        </div>

        <!-- Order Type -->
        <div class="info-card">
            <div class="info-card-title">
                <i class="fas fa-tag"></i>Order Type
            </div>
            <div class="info-card-value">
                {% if order.table %}
                    <i class="fas fa-chair"></i> Table #{{ order.table.number }}
                {% elif order.order_type == 'delivery' %}
                    <i class="fas fa-motorcycle"></i> Delivery
                {% else %}
                    <i class="fas fa-shopping-bag"></i> Takeaway
                {% endif %}
            </div>
        </div>

        <!-- Status -->
        <div class="info-card">
            <div class="info-card-title">
                <i class="fas fa-info-circle"></i>Status
            </div>
            <span class="status-badge {% if order.status == 'pending' %}pending{% elif order.status == 'completed' %}completed{% else %}cancelled{% endif %}">
                {{ order.get_status_display }}
            </span>
        </div>

        <!-- Payment Status -->
        <div class="info-card">
            <div class="info-card-title">
                <i class="fas fa-wallet"></i>Payment Status
            </div>
            <span class="status-badge {% if order.payment_status == 'paid' %}paid{% else %}unpaid{% endif %}">
                {{ order.payment_status|upper }}
            </span>
        </div>

        <!-- Amount -->
        <div class="info-card">
            <div class="info-card-title">
                <i class="fas fa-money-bill"></i>Total Amount
            </div>
            <div class="info-card-value">
                Rs.{% if order.order_type == 'delivery' %}{{ order.total_amount|add:order.delivery_charge }}{% else %}{{ order.total_amount }}{% endif %}
            </div>
        </div>

        <!-- Created -->
        <div class="info-card">
            <div class="info-card-title">
                <i class="fas fa-calendar"></i>Created
            </div>
            <div class="info-card-meta">{{ order.created_at|date:"d-M-Y" }}</div>
            <div class="info-card-meta">{{ order.created_at|date:"H:i:s" }}</div>
        </div>
    </div>

    <!-- Delivery Info (if applicable) -->
    {% if order.order_type == 'delivery' %}
    <div class="content-card">
        <div class="card-header">
            <h2>
                <i class="fas fa-map-marker-alt"></i> Delivery Information
            </h2>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">Delivery Address</label>
                <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                    {{ order.delivery_address }}
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Delivery Charge</label>
                <div style="font-size: 1.3rem; font-weight: 700; color: #0d6efd;">
                    Rs.{{ order.delivery_charge }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Order Items -->
    <div class="content-card">
        <div class="card-header">
            <h2>
                <i class="fas fa-boxes"></i> Order Items
            </h2>
            <button onclick="openAddItemModal()" class="btn btn-success" style="padding: 0.5rem 1rem;">
                <i class="fas fa-plus"></i> Add Item
            </button>
        </div>
        <div class="card-body">
            {% if order.items.all %}
            <table class="items-table" id="order-items-table">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order_item in order.items.all %}
                    <tr id="item-row-{{ order_item.id }}">
                        <td class="item-name">{{ order_item.item.name }}</td>
                        <td class="item-qty">{{ order_item.quantity }}</td>
                        <td class="item-price">Rs.{{ order_item.item.price }}</td>
                        <td class="item-total">Rs.{{ order_item.quantity|multiply:order_item.item.price }}</td>
                        <td style="text-align: center;">
                            <button onclick="removeOrderItem('{{ order_item.id }}')" class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Summary -->
            <div class="summary-section">
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span>Rs.{{ order.total_amount }}</span>
                </div>
                {% if order.order_type == 'delivery' %}
                <div class="summary-row">
                    <span>Delivery Charge:</span>
                    <span>Rs.{{ order.delivery_charge }}</span>
                </div>
                {% endif %}
                <div class="summary-row total">
                    <span>Total Amount:</span>
                    <span id="canonical-total" data-total="{% if order.order_type == 'delivery' %}{{ order.total_amount|add:order.delivery_charge }}{% else %}{{ order.total_amount }}{% endif %}">
                        Rs.{% if order.order_type == 'delivery' %}{{ order.total_amount|add:order.delivery_charge }}{% else %}{{ order.total_amount }}{% endif %}
                    </span>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“¦</div>
                <p>No items in this order yet</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Settled Payments -->
    <div class="content-card">
        <div class="card-header">
            <h2>
                <i class="fas fa-check-circle"></i> Settled Payments ({{ order.payments.all.count }})
            </h2>
        </div>
        <div class="card-body">
            {% if order.payments.all %}
            <div id="settled-payments">
                {% for payment in order.payments.all %}
                <div class="payment-item" id="payment-{{ payment.id }}">
                    <div class="payment-item-header">
                        <div>
                            <div class="payment-method">{{ payment.payment_method|capfirst }}</div>
                            {% if payment.transaction_id %}
                            <div class="info-card-meta">ID: {{ payment.transaction_id }}</div>
                            {% endif %}
                        </div>
                        <div class="payment-amount">Rs.{{ payment.amount }}</div>
                    </div>
                    <div class="payment-actions">
                        <button onclick="editPayment('{{ payment.id }}')" class="btn btn-info" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="deletePayment('{{ payment.id }}')" class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ’°</div>
                <p>No payments settled yet</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Add Payment Section -->
    <div class="content-card">
        <div class="card-header">
            <h2>
                <i class="fas fa-credit-card"></i> Add Payment
            </h2>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'restaurant:process_payment' pk=order.id %}">
                {% csrf_token %}
                <div id="payment-forms">
                    <div class="form-group payment-form">
                        <label class="form-label">Payment Method</label>
                        <select name="payment_method" class="form-control">
                            {% for method in payment_methods %}
                                <option value="{{ method.0 }}">{{ method.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group payment-form">
                        <label class="form-label">Amount</label>
                        <input type="number" name="amount" step="0.01" class="form-control" placeholder="0.00" oninput="updateRemainingAmount()">
                    </div>
                    <div class="form-group payment-form">
                        <label class="form-label">Transaction ID (Optional)</label>
                        <input type="text" name="transaction_id" class="form-control" placeholder="e.g., TXN12345">
                    </div>
                </div>
                <div class="summary-section">
                    <div class="summary-row">
                        <span>Total Amount Due:</span>
                        <span id="total-due">Rs.{% if order.order_type == 'delivery' %}{{ order.total_amount|add:order.delivery_charge }}{% else %}{{ order.total_amount }}{% endif %}</span>
                    </div>
                    <div class="summary-row total">
                        <span>Remaining Amount:</span>
                        <span id="remaining-amount">Rs.{% if order.order_type == 'delivery' %}{{ order.total_amount|add:order.delivery_charge }}{% else %}{{ order.total_amount }}{% endif %}</span>
                    </div>
                </div>
                <div class="action-buttons" style="margin-top: 1.5rem;">
                    <button type="button" onclick="addPaymentForm()" class="btn btn-secondary">
                        <i class="fas fa-plus"></i> Add Another
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Settle Payment
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button onclick="openPrintPreview('kot')" class="btn btn-primary">
            <i class="fas fa-print"></i> Print KOT
        </button>
        <button onclick="openPrintPreview('bill')" class="btn btn-success">
            <i class="fas fa-receipt"></i> Print Bill
        </button>
        {% if order.status != 'completed' and order.status != 'cancelled' %}
        <a href="{% url 'restaurant:close_order' pk=order.id %}" class="btn btn-primary">
            <i class="fas fa-check-double"></i> Close Order
        </a>
        {% endif %}
        {% if order.status != 'cancelled' %}
        <button onclick="openCancelModal()" class="btn btn-danger">
            <i class="fas fa-times"></i> Cancel Order
        </button>
        {% endif %}
        <a href="{% url 'restaurant:order_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Add Item Modal -->
<div id="add-item-modal" class="modal-backdrop">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-box-open"></i> Add Item to Order</h3>
            <button onclick="closeAddItemModal()" class="btn-close">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Category</label>
                <select id="category-filter" class="form-control" onchange="filterMenuItems()">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Item</label>
                <select id="menu-item" class="form-control">
                    {% for item in menu_items %}
                        <option value="{{ item.id }}" data-category="{{ item.category.id }}" data-price="{{ item.price }}">
                            {{ item.name }} - Rs.{{ item.price }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Quantity</label>
                <input type="number" id="item-quantity" value="1" min="1" class="form-control">
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeAddItemModal()" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button onclick="addItemToOrder()" class="btn btn-success">
                <i class="fas fa-check"></i> Add Item
            </button>
        </div>
    </div>
</div>

<!-- Print Preview Modal -->
<div id="print-modal" class="modal-backdrop">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3><i class="fas fa-print"></i> Print Preview</h3>
            <button onclick="closePreview()" class="btn-close">Ã—</button>
        </div>
        <div class="modal-body" id="print-preview" style="max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
            <!-- Preview content will be inserted here -->
        </div>
        <div class="modal-footer">
            <button onclick="printDocument()" class="btn btn-primary">
                <i class="fas fa-print"></i> Print
            </button>
            <button onclick="closePreview()" class="btn btn-secondary">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div id="cancel-modal" class="modal-backdrop">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h3><i class="fas fa-ban"></i> Cancel Order</h3>
            <button onclick="closeCancelModal()" class="btn-close">Ã—</button>
        </div>
        <div class="modal-body">
            {% if order.payments.all %}
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                <p style="margin: 0; color: #856404; font-weight: 600;">
                    <i class="fas fa-exclamation-triangle"></i> Warning: This order has settled payments.
                </p>
                <p style="margin: 0.5rem 0 0 0; color: #856404; font-size: 0.9rem;">
                    Cancelling will not refund the payments automatically.
                </p>
            </div>
            {% endif %}
            <form method="post" action="{% url 'restaurant:cancel_order' pk=order.id %}" onsubmit="return confirm('Are you sure you want to cancel this order?');">
                {% csrf_token %}
                <div class="form-group">
                    <label class="form-label">Reason for Cancellation (Optional)</label>
                    <textarea name="cancellation_reason" class="form-control" rows="4" placeholder="Enter cancellation reason..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeCancelModal()" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Keep Order
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-check"></i> Cancel Order
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="order-meta" data-table-number="{% if order.table %}{{ order.table.number }}{% else %}{% endif %}" data-order-id="{{ order.id }}" style="display:none;"></div>

<script>
    // @ts-nocheck
    // Build menuItems and categories from the rendered DOM selects to avoid embedding Django template loops inside JS
    let menuItems = [];
    let categories = [];
    
    let orderId = "{{ order.id }}";
    let totalAmount = parseFloat("{{ order.total_amount|default:0 }}") || 0;
    let deliveryCharge = parseFloat("{{ order.delivery_charge|default:0 }}") || 0;
    let orderNumber = "{{ order.order_id }}";
    let customerName = "{{ order.customer_name }}";
    let customerPhone = "{{ order.customer_phone }}";
    let createdAt = "{{ order.created_at|date:'d/m/Y H:i' }}";
    let deliveryAddress = "{{ order.delivery_address }}";
    let specialNotes = "{{ order.special_notes }}";
    // Read table number from DOM data attribute to avoid embedding Django tags directly in JS
    let tableNumberRaw = document.getElementById('order-meta') ? document.getElementById('order-meta').dataset.tableNumber : '';
    let tableNumber = tableNumberRaw !== '' ? tableNumberRaw : null;
    // @ts-check
    // @ts-check
    
    // Populate menuItems and categories after the DOM is ready by reading the existing select options
    document.addEventListener('DOMContentLoaded', function() {
        const menuSelect = document.getElementById('menu-item');
        if (menuSelect) {
            Array.from(menuSelect.options).forEach(opt => {
                if (opt.value) {
                    // option text is like "Name - Rs.X", so extract name before the price suffix
                    const text = opt.textContent || '';
                    const name = text.split(' - Rs.')[0].trim();
                    menuItems.push({
                        id: opt.value,
                        name: name,
                        price: parseFloat(opt.dataset.price) || 0,
                        category: opt.dataset.category || ''
                    });
                }
            });
        }
    
        const categorySelect = document.getElementById('category-filter');
        if (categorySelect) {
            Array.from(categorySelect.options).forEach(opt => {
                if (opt.value) {
                    categories.push({
                        id: opt.value,
                        name: (opt.textContent || '').trim()
                    });
                }
            });
        }
    
        // Ensure totals are updated once the settled payments are read from DOM
        if (typeof updateDisplayTotals === 'function') {
            updateDisplayTotals();
        }
    });

    function openAddItemModal() {
        document.getElementById('add-item-modal').classList.add('active');
    }

    function closeAddItemModal() {
        document.getElementById('add-item-modal').classList.remove('active');
    }

    function filterMenuItems() {
        const categoryId = document.getElementById('category-filter').value;
        const menuSelect = document.getElementById('menu-item');
        const options = menuSelect.querySelectorAll('option');

        options.forEach(option => {
            if (categoryId === '' || option.dataset.category === categoryId) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
    }

    function updateDisplayTotals() {
        const totalDue = totalAmount + deliveryCharge;
        let totalPaid = 0;

        document.querySelectorAll('#settled-payments .payment-amount').forEach(el => {
            const amount = parseFloat(el.textContent.replace('Rs.', ''));
            totalPaid += isNaN(amount) ? 0 : amount;
        });

        const remaining = totalDue - totalPaid;
        const remainingEl = document.getElementById('remaining-amount');
        if (remainingEl) {
            remainingEl.textContent = remaining.toFixed(2);
        }
    }

    function updateRemainingAmount() {
        const totalDue = totalAmount + deliveryCharge;
        let totalPaid = 0;

        document.querySelectorAll('input[name="amount"]').forEach(input => {
            const amount = parseFloat(input.value) || 0;
            totalPaid += amount;
        });

        document.querySelectorAll('#settled-payments .payment-amount').forEach(el => {
            const amount = parseFloat(el.textContent.replace('Rs.', ''));
            totalPaid += isNaN(amount) ? 0 : amount;
        });

        const remaining = totalDue - totalPaid;
        const remainingEl = document.getElementById('remaining-amount');
        if (remainingEl) {
            remainingEl.textContent = remaining.toFixed(2);
        }
    }

    function addItemToOrder() {
        const itemSelect = document.getElementById('menu-item');
        const quantityInput = document.getElementById('item-quantity');

        const itemId = itemSelect.value;
        const quantity = parseInt(quantityInput.value);

        if (!itemId || quantity < 1) {
            showNotification('Please select an item and quantity', 'error');
            return;
        }

        fetch(`/restaurant/orders/${orderId}/add-item/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                item_id: itemId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Item added successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('Error adding item: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('Error adding item', 'error');
        });
    }

    function removeOrderItem(itemId) {
        if (confirm('Are you sure you want to remove this item?')) {
            fetch(`/restaurant/orders/${orderId}/remove-item/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    item_id: itemId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Item removed', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('Error removing item', 'error');
                }
            })
            .catch(error => {
                showNotification('Error removing item', 'error');
            });
        }
    }

    function addPaymentForm() {
        const paymentForms = document.getElementById('payment-forms');
        const newForm = document.createElement('div');
        newForm.className = 'form-group payment-form';
        newForm.innerHTML = `
            <label class="form-label">Payment Method</label>
            <select name="payment_method" class="form-control">
                {% for method in payment_methods %}
                    <option value="{{ method.0 }}">{{ method.1 }}</option>
                {% endfor %}
            </select>
            <label class="form-label" style="margin-top: 1rem;">Amount</label>
            <input type="number" name="amount" step="0.01" class="form-control" placeholder="0.00" oninput="updateRemainingAmount()">
            <label class="form-label" style="margin-top: 1rem;">Transaction ID (Optional)</label>
            <input type="text" name="transaction_id" class="form-control" placeholder="e.g., TXN12345">
        `;
        paymentForms.appendChild(newForm);
    }

    function editPayment(paymentId) {
        if (confirm('Edit functionality requires server endpoint. Contact administrator.')) {
            // Placeholder for edit functionality
        }
    }

    function deletePayment(paymentId) {
        if (confirm('Are you sure you want to delete this payment?')) {
            fetch(`/restaurant/payments/${paymentId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Payment deleted', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('Error deleting payment', 'error');
                }
            })
            .catch(error => {
                showNotification('Error deleting payment', 'error');
            });
        }
    }

    function openPrintPreview(type) {
        const modal = document.getElementById('print-modal');
        const preview = document.getElementById('print-preview');

        if (type === 'kot') {
            preview.innerHTML = generateKOTPreview();
        } else {
            preview.innerHTML = generateBillPreview();
        }

        modal.classList.add('active');
    }

    function generateKOTPreview() {
        const items = document.querySelectorAll('#order-items-table tbody tr');
        let itemsHtml = '';
        items.forEach(row => {
            const name = row.querySelector('.item-name').textContent;
            const qty = row.querySelector('.item-qty').textContent;
            itemsHtml += `<tr><td>${name}</td><td style="text-align: right;">${qty}</td></tr>`;
        });

        let orderTypeDisplay = orderType === 'delivery' ? 'Delivery' : orderType === 'takeaway' ? 'Takeaway' : `Table #${tableNumber}`;

        return `
            <div style="font-family: monospace; padding: 1rem; text-align: center;">
                <h3>KITCHEN ORDER TICKET</h3>
                <hr>
                <p><strong>Order #${orderNumber}</strong></p>
                <p>${createdAt}</p>
                <p>${orderTypeDisplay}</p>
                <hr>
                <table style="width: 100%; margin: 1rem 0;">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Item</th>
                            <th style="text-align: right;">Qty</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
                <hr>
                ${specialNotes ? `<p><strong>Special Notes:</strong></p><p>${specialNotes}</p>` : ''}
            </div>
        `;
    }

    function generateBillPreview() {
        const items = document.querySelectorAll('#order-items-table tbody tr');
        let itemsHtml = '';
        items.forEach(row => {
            const name = row.querySelector('.item-name').textContent;
            const qty = row.querySelector('.item-qty').textContent;
            const price = row.querySelector('.item-price').textContent;
            const total = row.querySelector('.item-total').textContent;
            itemsHtml += `<tr><td>${name}</td><td style="text-align: center;">${qty}</td><td style="text-align: right;">${price}</td><td style="text-align: right;">${total}</td></tr>`;
        });

        const subtotal = totalAmount;
        const delivery = deliveryCharge || 0;
        const grandTotal = subtotal + delivery;

        let orderTypeDisplay = orderType === 'delivery' ? 'Delivery Order' : orderType === 'takeaway' ? 'Takeaway' : `Table #${tableNumber}`;

        return `
            <div style="font-family: monospace; padding: 1rem; text-align: center; max-width: 80mm;">
                <h3>RESTAURANT NAME</h3>
                <p>Address Line 1<br>Address Line 2<br>Phone: XXX-XXX-XXXX</p>
                <hr>
                <p><strong>Bill #${orderNumber}</strong></p>
                <p>${createdAt}</p>
                <p>Order Type: ${orderTypeDisplay}</p>
                ${deliveryAddress ? `<p>Address: ${deliveryAddress}</p>` : ''}
                <p><strong>Customer:</strong> ${customerName}<br><strong>Phone:</strong> ${customerPhone}</p>
                <hr>
                <table style="width: 100%; margin: 1rem 0; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px dashed #000;">
                            <th style="text-align: left; padding: 0.5rem 0;">Item</th>
                            <th style="text-align: center; padding: 0.5rem 0;">Qty</th>
                            <th style="text-align: right; padding: 0.5rem 0;">Price</th>
                            <th style="text-align: right; padding: 0.5rem 0;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
                <hr>
                <p style="text-align: right;"><strong>Subtotal:</strong> Rs.${subtotal}</p>
                ${delivery > 0 ? `<p style="text-align: right;"><strong>Delivery Charge:</strong> Rs.${delivery}</p>` : ''}
                <p style="text-align: right; font-weight: bold; font-size: 1.2em;"><strong>Total:</strong> Rs.${grandTotal}</p>
                <hr>
                <p><strong>Thank you for visiting!</strong><br>Please visit again</p>
            </div>
        `;
    }

    function closePreview() {
        document.getElementById('print-modal').classList.remove('active');
    }

    function printDocument() {
        window.print();
    }

    function openCancelModal() {
        document.getElementById('cancel-modal').classList.add('active');
    }

    function closeCancelModal() {
        document.getElementById('cancel-modal').classList.remove('active');
    }

    function showNotification(message, type) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
        toast.style.color = type === 'success' ? '#155724' : '#721c24';
        toast.style.borderLeft = `4px solid ${type === 'success' ? '#28a745' : '#dc3545'}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideInUp 0.3s ease reverse';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Close modals on backdrop click
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        updateDisplayTotals();
    });
</script>

{% endblock %}

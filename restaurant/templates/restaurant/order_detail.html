{% extends 'restaurant/base.html' %}
{% load custom_filters %}

{% block title %}Order Details{% endblock %}

{% block content %}
{% load static %}
{% load tz %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
<style>
    body {
        background: #f0f2f5;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .page-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1a1a1a;
        margin: 0;
    }
    
    .order-number {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1a1a1a;
    }
    
    .main-layout {
        display: grid;
        grid-template-columns: 1fr 1.2fr;
        gap: 2rem;
    }
    
    .left-column, .right-column {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .card-content {
        padding: 1.5rem;
    }
    
    .info-grid {
        display: grid;
        gap: 1.25rem;
    }
    
    .info-row {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 1rem;
    }
    
    .info-label {
        font-weight: 600;
        color: #4a5568;
        font-size: 0.9rem;
    }
    
    .info-value {
        color: #1a1a1a;
        font-size: 0.9rem;
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .status-badge.pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-badge.completed {
        background: #d4edda;
        color: #155724;
    }
    
    .status-badge.unpaid {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-badge.paid {
        background: #d4edda;
        color: #155724;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
    
    .section-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
        color: #1a1a1a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .items-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .items-table thead {
        background: #f8f9fa;
    }
    
    .items-table th {
        padding: 0.75rem 1rem;
        text-align: left;
        font-weight: 700;
        color: #6c757d;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .items-table td {
        padding: 1rem;
        border-bottom: 1px solid #f1f3f5;
    }
    
    .items-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .items-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .item-name {
        font-weight: 600;
        color: #1a1a1a;
    }
    
    .text-center {
        text-align: center;
    }
    
    .text-right {
        text-align: right;
    }
    
    .special-notes-box {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .special-notes-box h4 {
        font-size: 0.85rem;
        font-weight: 700;
        color: #6c757d;
        margin: 0 0 0.5rem 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .special-notes-box p {
        margin: 0;
        color: #495057;
        font-size: 0.9rem;
    }
    
    .summary-table {
        margin-top: 1.5rem;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        font-size: 0.95rem;
    }
    
    .summary-row.total {
        border-top: 2px solid #e9ecef;
        padding-top: 1rem;
        margin-top: 0.5rem;
        font-size: 1.1rem;
        font-weight: 700;
        color: #0066cc;
    }
    
    .payment-form-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .payment-form-section h4 {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: #1a1a1a;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-group {
        margin-bottom: 0;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: #495057;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    
    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }
    
    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.875rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-primary {
        background: #0066cc;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0052a3;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #218838;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .btn-sm {
        padding: 0.35rem 0.75rem;
        font-size: 0.8rem;
    }
    
    .btn-add-payment {
        background: #e7f5ff;
        color: #0066cc;
        border: 1px dashed #0066cc;
    }
    
    .btn-add-payment:hover {
        background: #d0ebff;
    }
    
    .payment-item {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .payment-info h5 {
        margin: 0 0 0.25rem 0;
        font-size: 0.95rem;
        font-weight: 700;
        color: #1a1a1a;
    }
    
    .payment-info p {
        margin: 0;
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .payment-amount {
        font-size: 1.1rem;
        font-weight: 700;
        color: #28a745;
        margin-right: 1rem;
    }
    
    .payment-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
    }
    
    .action-buttons .btn {
        flex: 1;
        min-width: 140px;
        justify-content: center;
    }
    
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .modal-backdrop.active {
        display: flex;
    }
    
    .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }
    
    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6c757d;
        padding: 0;
        line-height: 1;
    }
    
    @media (max-width: 1024px) {
        .main-layout {
            grid-template-columns: 1fr;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .info-row {
            grid-template-columns: 1fr;
            gap: 0.25rem;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .action-buttons .btn {
            width: 100%;
        }
    }
</style>

<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1>Order Details</h1>
        <div class="order-number">Order #{{ order.order_id }}</div>
    </div>

    <div class="main-layout">
        <!-- Left Column -->
        <div class="left-column">
            <!-- Customer & Order Info Card -->
            <div class="card">
                <div class="card-content">
                    <div class="info-grid">
                        <div class="info-row">
                            <div class="info-label">Name:</div>
                            <div class="info-value">{{ order.customer_name }}</div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">Phone:</div>
                            <div class="info-value">{{ order.customer_phone }}</div>
                        </div>
                        
                        {% if order.order_type == 'delivery' %}
                        <div class="info-row">
                            <div class="info-label">Delivery Address:</div>
                            <div class="info-value">
                                {{ order.delivery_address }}
                                <button class="btn btn-sm btn-primary" style="margin-top: 0.5rem;" data-bs-toggle="modal" data-bs-target="#editAddressModal">
                                    Edit Address
                                </button>
                            </div>
                        </div>
                        
                        {% if order.delivery_landmark %}
                        <div class="info-row">
                            <div class="info-label">Landmark:</div>
                            <div class="info-value">{{ order.delivery_landmark }}</div>
                        </div>
                        {% endif %}
                        {% endif %}
                        
                        
                        <div class="info-row">
                            <div class="info-label">Order Type:</div>
                            <div class="info-value">
                                {% if order.table %}
                                    Table #{{ order.table.number }}
                                {% elif order.order_type == 'delivery' %}
                                    Delivery
                                {% else %}
                                    Takeaway
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">Payment Status:</div>
                            <div class="info-value">
                                <span class="status-badge {% if remaining_amount|floatformat:2 == '0.00' %}paid{% else %}unpaid{% endif %}">
                                    {% if remaining_amount|floatformat:2 == '0.00' %}Paid{% else %}Unpaid{% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">Status:</div>
                            <div class="info-value">
                                <span class="status-badge {{ order.status }}">
                                    {{ order.get_status_display }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">Created</div>
                            <div class="info-value">
                                <span class="js-created-at" data-utc="{{ order.created_at|date:'c' }}">{{ order.created_at|date:"d M Y, h:i:s A" }}</span>
                                <div style="font-size: 0.8rem; color: #6c757d; margin-top: 0.25rem;">
                                    Created By: {% if order.created_by %}{{ order.created_by.get_full_name|default:order.created_by.username }}{% else %}System{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Section -->
            <div class="card">
                <div class="section-header">
                    <h3>Add Payment</h3>
                </div>
                <div class="card-content">
                    <form id="add-payment-form" method="post" action="{% url 'restaurant:add_payment' order.id %}">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <select name="payment_method" class="form-select">
                                    <option value="cash">Cash</option>
                                    <option value="card">Card</option>
                                    <option value="fonepay">Fonepay</option>
                                    <option value="bank">Bank</option>
                                    <option value="khalti">Khalti</option>
                                    <option value="ipay">Ipay</option>
                                    <option value="prabhu">Prabhu</option>
                                    <option value="esewa">Esewa</option>
                                    <option value="imepay">Imepay</option>
                                    <option value="connectips">Connectips</option>
                                    <option value="sct">SCT</option>
                                    <option value="qr_code">QR Code</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" name="amount" step="0.01" class="form-control" placeholder="1200" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Transaction ID (Optional)</label>
                                <input type="text" name="transaction_id" class="form-control" placeholder="">
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-add-payment">
                            <i class="fas fa-plus"></i> Add payment
                        </button>
                    </form>
                </div>
            </div>

            <!-- Settled Payments -->
            <div class="card">
                <div class="section-header">
                    <h3>Settled Payments ({{ order.payments.all.count }})</h3>
                </div>
                <div class="card-content">
                    {% if order.payments.all %}
                    <div id="settled-payments">
                        {% for payment in order.payments.all %}
                        <div class="payment-item" id="payment-{{ payment.id }}">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="payment-info">
                                    <h5 class="payment-method">{{ payment.payment_method|capfirst }}</h5>
                                    {% if payment.transaction_id %}
                                    <p class="payment-transaction-id">{{ payment.transaction_id }}</p>
                                    {% endif %}
                                </div>
                                <div class="payment-amount" data-amount="{{ payment.amount }}">Rs. {{ payment.amount }}</div>
                            </div>
                            <div class="payment-actions">
                                <button onclick="editPayment('{{ payment.id }}')" class="btn btn-sm btn-primary text-primary">
                                    Edit
                                </button>
                                <button onclick="savePayment('{{ payment.id }}')" class="btn btn-sm btn-success text-success d-none">
                                    Save
                                </button>
                                <button onclick="deletePayment('{{ payment.id }}')" class="btn btn-sm btn-danger">
                                    Delete
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p style="text-align: center; color: #6c757d; padding: 2rem 0;">No payments settled yet</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="right-column">
            <!-- Order Items Card -->
            <div class="card">
                <div class="section-header">
                    <h3><i class="fas fa-boxes"></i> Order Items</h3>
                    <button onclick="openAddItemModal()" class="btn btn-success btn-sm">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                </div>
                <div class="card-content" style="padding: 0;">
                    {% if order.items.all %}
                    <table class="items-table" id="order-items-table">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th class="text-center">Qty</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Total</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order_item in order.items.all %}
                            <tr id="item-row-{{ order_item.id }}">
                                <td class="item-name">{{ order_item.item.name }}</td>
                                <td class="text-center qty-cell-{{ order_item.id }}">{{ order_item.quantity }}</td>
                                <td class="text-right">Rs.{{ order_item.item.price }}</td>
                                <td class="text-right total-cell-{{ order_item.id }}">Rs.{{ order_item.quantity|multiply:order_item.item.price }}</td>
                                <td class="text-center">
                                    <button onclick="editOrderItem('{{ order_item.id }}', {{ order_item.quantity }}, {{ order_item.item.price }})" class="btn btn-primary btn-sm edit-btn-{{ order_item.id }}">
                                        Edit
                                    </button>
                                    <button onclick="saveOrderItem('{{ order_item.id }}')" class="btn btn-success btn-sm save-btn-{{ order_item.id }} d-none">
                                        Save
                                    </button>
                                    <button onclick="removeOrderItem('{{ order_item.id }}')" class="btn btn-danger btn-sm delete-btn-{{ order_item.id }}">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% if order.special_notes %}
                    <div class="special-notes-box" style="margin: 1.5rem;">
                        <h4>Special Notes</h4>
                        <p>{{ order.special_notes }}</p>
                    </div>
                    {% endif %}

                    <!-- Summary -->
                    <div style="padding: 1.5rem;">
                        <div class="summary-table">
                            <div class="summary-row">
                                <span>Sub Total</span>
                                <span>{{ order.total_amount }}</span>
                            </div>
                            {% if order.order_type == 'delivery' %}
                            <div class="summary-row">
                                <span>Delivery Charge</span>
                                <span>{{ order.delivery_charge }}</span>
                            </div>
                            {% endif %}
                            {% if order.discount_amount %}
                            <div class="summary-row">
                                <span>Discount</span>
                                <span>-{{ order.discount_amount }}</span>
                            </div>
                            {% endif %}
                            <div class="summary-row">
                                <span>Remaining</span>
                                <span id="remaining-amount" data-remaining="{{ remaining_amount|floatformat:2 }}">Rs. {{ remaining_amount|floatformat:2 }}</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total amount</span>
                                <span id="canonical-total" data-total="{% if order.order_type == 'delivery' %}{{ order.total_amount|add:order.delivery_charge }}{% else %}{{ order.total_amount }}{% endif %}">
                                    Rs.{% if order.order_type == 'delivery' %}{{ order.total_amount|add:order.delivery_charge }}{% else %}{{ order.total_amount }}{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p style="text-align: center; color: #6c757d; padding: 3rem 0;">No items in this order yet</p>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button onclick="openPrintPreview('kot')" class="btn btn-primary">
                    <i class="fas fa-print"></i> Print KOT
                </button>
                <button onclick="openPrintPreview('bill')" class="btn btn-primary">
                    <i class="fas fa-receipt"></i> Print Bill
                </button>
                {% if order.status != 'completed' and order.status != 'cancelled' %}
                <button onclick="closeOrderConfirm()" class="btn btn-success">
                    <i class="fas fa-check"></i> Close Order
                </button>
                {% endif %}
                {% if order.status != 'cancelled' %}
                <button onclick="openCancelModal()" class="btn btn-danger">
                    <i class="fas fa-times"></i> Cancel Order
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div id="add-item-modal" class="modal-backdrop">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Item to Order</h3>
            <button onclick="closeAddItemModal()" class="btn-close">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Category</label>
                <select id="category-filter" class="form-select" onchange="filterMenuItems()">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label class="form-label">Menu Item</label>
                <select id="menu-item" class="form-select">
                    <option value="">-- Select item --</option>
                    {% for mi in menu_items %}
                        <option value="{{ mi.id }}" data-price="{{ mi.price }}" data-category="{% if mi.category %}{{ mi.category.id }}{% endif %}">{{ mi.name }} - Rs.{{ mi.price }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label class="form-label">Quantity</label>
                <input id="item-quantity" type="number" min="1" value="1" class="form-control">
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeAddItemModal()" class="btn btn-secondary">Close</button>
            <button onclick="addItemToOrder()" class="btn btn-primary">Add Item</button>
        </div>
    </div>
</div>

<!-- Print Preview Modal -->
<div id="print-modal" class="modal-backdrop">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>Print Preview</h3>
            <button onclick="closePreview()" class="btn-close">×</button>
        </div>
        <div class="modal-body" id="print-preview" style="max-height: 500px; overflow-y: auto;">
            <!-- Preview content -->
        </div>
        <div class="modal-footer">
            <button onclick="printDocument()" class="btn btn-primary">Print</button>
            <button onclick="closePreview()" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div id="cancel-modal" class="modal-backdrop">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Cancel Order</h3>
            <button onclick="closeCancelModal()" class="btn-close">×</button>
        </div>
        <form method="post" action="{% url 'restaurant:cancel_order' pk=order.id %}">
            {% csrf_token %}
            <div class="modal-body">
                {% if order.payments.all %}
                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0; color: #856404; font-weight: 600;">
                        <i class="fas fa-exclamation-triangle"></i> Warning: This order has settled payments.
                    </p>
                </div>
                {% endif %}
                <div class="form-group">
                    <label class="form-label">Reason for Cancellation (Optional)</label>
                    <textarea name="cancellation_reason" class="form-control" rows="4" placeholder="Enter cancellation reason..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeCancelModal()" class="btn btn-secondary">Keep Order</button>
                <button type="submit" class="btn btn-danger">Cancel Order</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Address Modal -->
<div class="modal fade" id="editAddressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Delivery Address</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="edit-address-form">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="delivery_address_input" name="delivery_address" rows="3">{{ order.delivery_address }}</textarea>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">Landmark</label>
                        <input type="text" class="form-control" id="delivery_landmark_input" name="delivery_landmark" value="{{ order.delivery_landmark }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="save-address-btn" class="btn btn-primary">Save Address</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>

    const csrf_token = '{{ csrf_token }}';
    const orderId = '{{ order.order_id }}';
    const orderPk = '{{ order.id }}';
    // URL templates for payment actions (0 will be replaced with actual id)
    const PAYMENT_EDIT_URL_TEMPLATE = "{% url 'restaurant:edit_payment' 0 %}";
    const PAYMENT_DELETE_URL_TEMPLATE = "{% url 'restaurant:delete_payment' 0 %}";

// Payment Management Functions
function addPaymentForm() {
    const paymentForms = document.getElementById('payment-forms');
    const newPaymentForm = document.createElement('div');
    newPaymentForm.classList.add('payment-form', 'mt-2');
    newPaymentForm.innerHTML = `
        <select name="payment_method" class="py-2 px-3 border rounded">
            {% for method in payment_methods %}
                <option value="{{ method.0 }}">{{ method.1 }}</option>
            {% endfor %}
        </select>
        <input type="number" name="amount" step="0.01" class="py-2 px-3 border rounded ml-2" 
               placeholder="Amount" oninput="updateRemainingAmount()">
        <input type="text" name="transaction_id" class="py-2 px-3 border rounded ml-2" 
               placeholder="Transaction ID (optional)">
    `;
    if (paymentForms) paymentForms.appendChild(newPaymentForm);
}

// consolidated updateRemainingAmount below (single implementation)

function editPayment(id) {
    const paymentItem = document.getElementById(`payment-${id}`);
    if (!paymentItem) return;
    const paymentMethod = paymentItem.querySelector('.payment-method') ? paymentItem.querySelector('.payment-method').innerText : '';
    const amountEl = paymentItem.querySelector('.payment-amount');
    const amount = amountEl ? amountEl.innerText.replace(/Rs\.?\s*/g, '') : '';
    const transactionEl = paymentItem.querySelector('.payment-transaction-id');
    const transactionId = transactionEl ? transactionEl.innerText : '';

    if (paymentItem.querySelector('.payment-method')) {
        paymentItem.querySelector('.payment-method').innerHTML = `
            <select class="py-2 px-3 border rounded">
                {% for method in payment_methods %}
                    <option value="{{ method.0 }}">{{ method.1 }}</option>
                {% endfor %}
            </select>
        `;
        // set select value to current method if available
        try{
            const sel = paymentItem.querySelector('.payment-method select');
            if (sel) sel.value = paymentMethod;
        }catch(e){/* ignore */}
    }
    if (amountEl) {
        const numericAmount = String(amount).replace(/[^0-9.\-\.]/g,'') || '';
        amountEl.innerHTML = `<input type="number" value="${numericAmount}" class="py-2 px-3 border rounded">`;
    }
    if (transactionEl) {
        transactionEl.innerHTML = `<input type="text" value="${transactionId}" class="py-2 px-3 border rounded">`;
    }

    const primaryBtn = paymentItem.querySelector('.text-primary');
    const successBtn = paymentItem.querySelector('.text-success');
    if (primaryBtn) primaryBtn.classList.add('d-none');
    if (successBtn) successBtn.classList.remove('d-none');
}

function savePayment(id) {
    const paymentItem = document.getElementById(`payment-${id}`);
    if (!paymentItem) return;
    const pmSelect = paymentItem.querySelector('.payment-method select');
    const paymentMethod = pmSelect ? pmSelect.value : '';
    const amountInput = paymentItem.querySelector('.payment-amount input');
    const amount = amountInput ? amountInput.value : '';
    const txInput = paymentItem.querySelector('.payment-transaction-id input');
    const transactionId = txInput ? txInput.value : '';

    // get CSRF from cookie
    const csrftoken = (function(){
        const m = document.cookie.match('(^|;)\\s*' + 'csrftoken' + '\\s*=\\s*([^;]+)');
        return m ? decodeURIComponent(m.pop()) : null;
    })();

    const editUrl = PAYMENT_EDIT_URL_TEMPLATE.replace('/0/', '/' + id + '/');
    console.log('Edit payment posting to', editUrl, {payment_method: paymentMethod, amount: amount, transaction_id: transactionId});
    fetch(editUrl, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken || ''
        },
        body: JSON.stringify({
            payment_method: paymentMethod,
            amount: amount,
            transaction_id: transactionId
        }),
    }).then(response => response.json())
    .then(data => {
        if (data && data.status === 'success'){
            if (paymentItem.querySelector('.payment-method')) paymentItem.querySelector('.payment-method').innerText = paymentMethod;
            const amountEl = paymentItem.querySelector('.payment-amount');
            if (amountEl) {
                const formattedAmount = parseFloat(amount).toFixed(2);
                amountEl.setAttribute('data-amount', formattedAmount);
                amountEl.innerText = `Rs. ${formattedAmount}`;
            }
            if (paymentItem.querySelector('.payment-transaction-id')) paymentItem.querySelector('.payment-transaction-id').innerText = transactionId;

            const primaryBtn = paymentItem.querySelector('.text-primary');
            const successBtn = paymentItem.querySelector('.text-success');
            if (primaryBtn) primaryBtn.classList.remove('d-none');
            if (successBtn) successBtn.classList.add('d-none');

            // update remaining and header counts
            if (window.updateRemaining) window.updateRemaining();
        } else {
            console.error('Edit payment failed', data);
            alert('Failed to save payment edits');
        }
    }).catch(err => { console.error('Edit payment error', err); alert('Failed to save payment edits'); });
}

function deletePayment(id) {
    if (!confirm('Are you sure you want to delete this payment?')) {
        return;
    }
    const csrftoken2 = (function(){
        const m = document.cookie.match('(^|;)\\s*' + 'csrftoken' + '\\s*=\\s*([^;]+)');
        return m ? decodeURIComponent(m.pop()) : null;
    })();
    const deleteUrl = PAYMENT_DELETE_URL_TEMPLATE.replace('/0/', '/' + id + '/');
    fetch(deleteUrl, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken2 || ''
        },
    }).then(response => response.json())
    .then(data => {
        if (data && data.status === 'success'){
            const paymentItem = document.getElementById(`payment-${id}`);
            if (paymentItem) paymentItem.remove();
            if (window.updateRemaining) window.updateRemaining();
        } else {
            console.error('Delete payment failed', data);
            alert('Failed to delete payment');
        }
    }).catch(err => { console.error('Delete payment error', err); alert('Failed to delete payment'); });
}


// Order Item Management Functions
function openAddItemModal() {
    const modal = document.getElementById('add-item-modal');
    if (!modal) return;
    modal.classList.remove('d-none');
    modal.classList.add('active');
    filterMenuItems(); // Initialize filtered items
}

function closeAddItemModal() {
    const modal = document.getElementById('add-item-modal');
    if (!modal) return;
    modal.classList.add('d-none');
    modal.classList.remove('active');
    // Reset form
    const cat = document.getElementById('category-filter');
    const qty = document.getElementById('item-quantity');
    if (cat) cat.value = '';
    if (qty) qty.value = 1;
}

function filterMenuItems() {
    const categoryId = document.getElementById('category-filter') ? document.getElementById('category-filter').value : '';
    const menuItems = document.getElementById('menu-item');
    if (!menuItems) return;
    const options = menuItems.options;
    for (let i = 0; i < options.length; i++) {
        const item = options[i];
        if (!categoryId || item.dataset.category === categoryId) {
            item.hidden = false;
        } else {
            item.hidden = true;
        }
    }
}

function calculateTotal(baseTotal, deliveryCharge = 0) {
    return parseFloat(baseTotal) + parseFloat(deliveryCharge);
}

function updateDisplayTotals(subtotal, deliveryCharge = 0) {
    const total = calculateTotal(subtotal, deliveryCharge);
    const canonical = document.getElementById('canonical-total');
    if (canonical) {
        canonical.dataset.total = total;
        canonical.textContent = `Rs.${total.toFixed(2)}`;
    }
    updateRemainingAmount();
}

function updateRemainingAmount() {
    let totalAmount = 0;
    const canonical = document.getElementById('canonical-total');
    
    // Try to get total from data-total attribute first
    if (canonical && canonical.dataset && canonical.dataset.total) {
        totalAmount = parseFloat(canonical.dataset.total) || 0;
    } 
    
    // If not found, try parsing the text content
    if (totalAmount === 0 && canonical) {
        const text = canonical.textContent || canonical.innerText || '';
        totalAmount = parseFloat(text.replace(/[^0-9.-]+/g, '')) || 0;
    }

    // settled payments
    let settledAmount = 0;
    const paymentElements = document.querySelectorAll('.payment-amount');
    paymentElements.forEach((element) => {
        const text = element.textContent || element.innerText || '';
        const cleanedText = text.replace(/Rs\.?\s*/g, '').trim();
        const amount = parseFloat(cleanedText) || 0;
        settledAmount += amount;
    });

    // pending/new payments
    let pendingAmount = 0;
    const amountInputs = document.querySelectorAll('input[name="amount"]');
    amountInputs.forEach(input => {
        pendingAmount += parseFloat(input.value) || 0;
    });

    const remainingAmount = totalAmount - settledAmount - pendingAmount;
    const remainingEl = document.getElementById('remaining-amount');
    if (remainingEl) remainingEl.textContent = 'Rs. ' + Number(remainingAmount || 0).toFixed(2);

    const remainingContainer = remainingEl ? remainingEl.parentElement : null;
    if (remainingContainer) {
        if (remainingAmount < 0) {
            remainingContainer.classList.add('text-danger');
        } else {
            remainingContainer.classList.remove('text-danger');
        }
    }

    // keep header count and other displays in sync
    try{ if (window.updateRemaining) window.updateRemaining(); }catch(e){}
}


function addItemToOrder() {
    const menuItemSelect = document.getElementById('menu-item');
    if (!menuItemSelect) { alert('Menu item selector not found'); return; }
    const selectedOption = menuItemSelect.options[menuItemSelect.selectedIndex];
    const quantityEl = document.getElementById('item-quantity');
    const quantity = quantityEl ? parseInt(quantityEl.value) : 1;
    const itemId = menuItemSelect.value;
    if (!itemId || !quantity || quantity < 1) {
        alert('Please select an item and enter a valid quantity');
        return;
    }

    fetch(`/order/${orderId}/add_item/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf_token
        },
        body: JSON.stringify({
            item_id: parseInt(itemId),
            quantity: quantity
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => { throw new Error(data.message || 'Failed to add item'); });
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            const tbody = document.querySelector('#order-items-table tbody');
            if (!tbody) return;
            const existingRow = document.getElementById(`item-row-${data.item_html.item_id}`);
            if (existingRow) {
                const qtyInput = existingRow.querySelector('input[type="number"]');
                if (qtyInput) qtyInput.value = data.item_html.quantity;
                const totalCell = existingRow.querySelector('td:nth-child(4)');
                if (totalCell) totalCell.textContent = `Rs.${data.item_html.total}`;
            } else {
                const newRow = document.createElement('tr');
                newRow.id = `item-row-${data.item_html.item_id}`;
                newRow.innerHTML = `
                    <td class="py-2 px-3 border-bottom">${data.item_html.name}</td>
                    <td class="py-2 px-3 border-bottom text-center">
                        <input type="number" 
                               value="${data.item_html.quantity}" 
                               min="1" 
                               class="w-20 px-2 py-1 border rounded"
                               onchange="updateItemQuantity(${data.item_html.item_id}, this.value)">
                    </td>
                    <td class="py-2 px-3 border-bottom text-right">Rs.${data.item_html.price}</td>
                    <td class="py-2 px-3 border-bottom text-right">Rs.${data.item_html.total}</td>
                    <td class="py-2 px-3 border-bottom text-center">
                        <button onclick="removeOrderItem(${data.item_html.item_id})" class="btn btn-sm btn-danger">Remove</button>
                    </td>
                `;
                tbody.appendChild(newRow);
            }
            updateDisplayTotals(data.new_total);
            closeAddItemModal();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || 'Error adding item. Please try again.');
    });
}


function updateItemQuantity(itemId, newQuantity) {
    if (newQuantity < 1) {
        alert('Quantity must be at least 1');
        return;
    }

    fetch(`/restaurant/order/${orderId}/add_item/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf_token
        },
        body: JSON.stringify({
            item_id: itemId,
            quantity: newQuantity,
            update: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const row = document.getElementById(`item-row-${itemId}`);
            if (row) row.querySelector('td:nth-child(4)').textContent = `Rs.${data.item_html.total}`;
            updateDisplayTotals(data.new_total);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating quantity');
    });
}

function editOrderItem(itemId, currentQty, itemPrice) {
    const qtyCell = document.querySelector(`.qty-cell-${itemId}`);
    const editBtn = document.querySelector(`.edit-btn-${itemId}`);
    const saveBtn = document.querySelector(`.save-btn-${itemId}`);
    
    if (!qtyCell) return;
    
    // Replace quantity display with input
    qtyCell.innerHTML = `<input type="number" id="qty-input-${itemId}" min="1" value="${currentQty}" class="form-control" style="width: 80px; margin: 0 auto;">`;
    
    // Toggle button visibility
    editBtn.classList.add('d-none');
    saveBtn.classList.remove('d-none');
    
    // Focus on input
    document.getElementById(`qty-input-${itemId}`).focus();
}

function saveOrderItem(itemId) {
    const qtyInput = document.getElementById(`qty-input-${itemId}`);
    if (!qtyInput) return;
    
    const newQty = parseInt(qtyInput.value);
    if (!newQty || newQty < 1) {
        alert('Please enter a valid quantity');
        return;
    }
    
    fetch(`/order/${orderId}/update_item/${itemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf_token
        },
        body: JSON.stringify({
            quantity: newQty
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update qty cell back to text
            const qtyCell = document.querySelector(`.qty-cell-${itemId}`);
            const totalCell = document.querySelector(`.total-cell-${itemId}`);
            const editBtn = document.querySelector(`.edit-btn-${itemId}`);
            const saveBtn = document.querySelector(`.save-btn-${itemId}`);
            
            qtyCell.textContent = newQty;
            totalCell.textContent = `Rs.${(newQty * data.item_price).toFixed(2)}`;
            
            // Toggle button visibility
            editBtn.classList.remove('d-none');
            saveBtn.classList.add('d-none');
            
            // Update totals
            updateDisplayTotals(data.new_total);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating item quantity');
    });
}

function removeOrderItem(itemId) {
    if (!confirm('Are you sure you want to remove this item?')) {
        return;
    }

    fetch(`/order/${orderId}/remove_item/${itemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf_token
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const row = document.getElementById(`item-row-${itemId}`);
            if (row) row.remove();
            updateDisplayTotals(data.new_total);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error removing item');
    });
}

// Initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
    const addItemModal = document.getElementById('add-item-modal');
    if (addItemModal) {
        addItemModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddItemModal();
            }
        });
    }

    updateRemainingAmount();
    setTimeout(() => updateRemainingAmount(), 100);
});


function openPrintPreview(type) {
        const modal = document.getElementById('print-modal');
        const container = modal ? modal.querySelector('.preview-container') : null;
        const template = document.getElementById(`${type}Template`);
        const preview = document.getElementById('print-preview');
        if (!modal || !preview || !template) return;
        document.getElementById('previewTitle') ? document.getElementById('previewTitle').textContent = type === 'kot' ? 'KOT Preview' : 'Bill Preview' : null;
        preview.innerHTML = template.innerHTML;
        modal.classList.remove('d-none');
        modal.classList.add('active');
    }

    function closePreview() {
        const modal = document.getElementById('print-modal');
        if (!modal) return;
        modal.classList.add('d-none');
        modal.classList.remove('active');
    }

    function printDocument() {
        window.print();
    }

    function downloadPDF() {
        const content = document.querySelector('#print-preview').innerHTML;
        const style = Array.from(document.querySelectorAll('style')).map(s => s.innerHTML).join('\n');
        const html = `
            <html>
                <head>
                    <style>
                        ${style}
                        body { width: 80mm; margin: 0; padding: 0; }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
            </html>
        `;
        const blob = new Blob([html], { type: 'application/pdf' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'order-document.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    document.addEventListener('click', function (e) {
        const modal = document.getElementById('cancel-modal');
        if (!modal || modal.style.display === 'none' || modal.classList.contains('d-none')) return;
        if (e.target === modal) closeCancelModal();
    });

    // Cancel modal handlers
    function openCancelModal() {
        const modal = document.getElementById('cancel-modal');
        if (!modal) return;
        modal.style.display = 'flex';
    }
    function closeCancelModal() {
        const modal = document.getElementById('cancel-modal');
        if (!modal) return;
        modal.style.display = 'none';
    }

    // Close Order Function
    function closeOrderConfirm() {
        const totalAmount = document.getElementById('canonical-total');
        if (!totalAmount) return;
        
        const total = parseFloat(totalAmount.dataset.total || totalAmount.textContent.replace(/[^0-9.-]/g, '')) || 0;
        
        // Calculate settled payments
        let settledAmount = 0;
        const paymentElements = document.querySelectorAll('.payment-amount');
        paymentElements.forEach((element) => {
            const text = element.textContent || element.innerText || '';
            const cleanedText = text.replace(/Rs\.?\s*/g, '').trim();
            const amount = parseFloat(cleanedText) || 0;
            settledAmount += amount;
        });
        
        const remaining = total - settledAmount;
        
        if (remaining > 0) {
            alert(`Cannot close order. Payment not fully settled.\n\nRemaining Amount: Rs.${remaining.toFixed(2)}\n\nPlease collect the remaining payment first.`);
            return;
        }
        
        // Payment is complete - confirm and close
        if (confirm(`Close Order #${orderId}?\n\nTotal Amount: Rs.${total.toFixed(2)}\nSettled Amount: Rs.${settledAmount.toFixed(2)}\n\nThis action will move the order to completed status.`)) {
            // Submit the form via POST using the correct URL pattern with pk
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{% url 'restaurant:close_order' order.id %}";
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrf_token;
            form.appendChild(csrfInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    try {
        // convert created_at to local timezone
        document.querySelectorAll('.js-created-at').forEach(function(el){
            const iso = el.dataset.utc;
            if (iso){
                const d = new Date(iso);
                el.textContent = d.toLocaleString();
            }
        });

        // helper to parse amounts like 'Rs. 123.45' or '123.45' or 'Rs.123'
        function parseAmount(text){
            if (!text) return 0;
            // Remove everything except digits and dots
            const cleaned = String(text).replace(/[^\d.]/g, '');
            console.log('parseAmount input:', JSON.stringify(text), 'cleaned:', JSON.stringify(cleaned));
            const n = parseFloat(cleaned);
            console.log('parseFloat result:', n);
            return isNaN(n) ? 0 : n;
        }

        function updateRemaining(){
            const totalEl = document.getElementById('canonical-total');
            if (!totalEl) return;
            
            // Use data-total attribute which is the actual numeric total
            let total = parseFloat(totalEl.dataset.total);
            if (isNaN(total)) {
                // fallback to parsing the text content
                total = parseAmount(totalEl.textContent);
            }

            // sum settled payments from DOM using data-amount attribute
            let settled = 0;
            const paymentEls = Array.from(document.querySelectorAll('.payment-amount'));
            console.log('Found payment elements:', paymentEls.length);
            
            paymentEls.forEach(function(el){
                // Use data-amount attribute if available, otherwise parse text
                let amt = parseFloat(el.dataset.amount);
                if (isNaN(amt)) {
                    amt = parseAmount(el.textContent);
                }
                console.log('Payment amount:', el.dataset.amount, '=>', amt);
                settled += amt;
            });

            console.log('Total:', total, 'Settled:', settled);
            const remaining = Math.max(0, total - settled);
            const remEl = document.getElementById('remaining-amount');
            if (remEl) remEl.textContent = 'Rs. ' + remaining.toFixed(2);

            // update Settled Payments header count if present
            try{
                const hdrs = document.querySelectorAll('.section-header h3');
                hdrs.forEach(function(h){
                    const txt = h.textContent || '';
                    if (txt.trim().startsWith('Settled Payments')){
                        const base = txt.split('(')[0].trim();
                        const newTxt = `${base} (${paymentEls.length})`;
                        h.textContent = newTxt;
                    }
                });
            }catch(e){/* ignore */}
        }

        // initialize remaining display
        updateRemaining();

        // Handle add-payment form via AJAX to update remaining live
        const addForm = document.getElementById('add-payment-form');
        if (addForm){
            addForm.addEventListener('submit', function(evt){
                evt.preventDefault();
                const formData = new FormData(addForm);
                const action = addForm.getAttribute('action');
                // include credentials so cookies (and CSRF cookie) are sent
                const addPaymentCsrfToken = (function(){
                    const m = document.cookie.match('(^|;)\\s*' + 'csrftoken' + '\\s*=\\s*([^;]+)');
                    return m ? decodeURIComponent(m.pop()) : null;
                })();
                fetch(action, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': addPaymentCsrfToken || ''
                    },
                    body: formData,
                })
                .then(resp => resp.json())
                .then(data => {
                    console.log('Add payment response', data);
                    if (data.status === 'success'){
                        // append payment to settled payments list
                        let paymentsContainer = document.getElementById('settled-payments');
                        const method = formData.get('payment_method') || '';
                        const amount = parseAmount(formData.get('amount')) || 0;
                        const tx = formData.get('transaction_id') || '';

                        if (!paymentsContainer){
                            // find the Settled Payments card and replace the placeholder message
                            const cards = document.querySelectorAll('.card');
                            for (const c of cards){
                                const hdr = c.querySelector('.section-header h3');
                                if (hdr && hdr.textContent && hdr.textContent.trim().includes('Settled Payments')){
                                    const content = c.querySelector('.card-content');
                                    if (content){
                                        // remove any paragraph placeholder
                                        const p = content.querySelector('p');
                                        if (p) p.remove();
                                        const container = document.createElement('div');
                                        container.id = 'settled-payments';
                                        content.appendChild(container);
                                        paymentsContainer = container;
                                    }
                                    break;
                                }
                            }
                        }

                        const item = document.createElement('div');
                        item.className = 'payment-item';
                        item.innerHTML = `<div style="display:flex;align-items:center;gap:1rem;">
                            <div class="payment-info"><h5>${method.charAt(0).toUpperCase()+method.slice(1)}</h5>${tx?('<p>ID: '+tx+'</p>'):''}</div>
                            <div class="payment-amount" data-amount="${amount.toFixed(2)}">Rs. ${amount.toFixed(2)}</div>
                        </div>`;

                        if (paymentsContainer){
                            paymentsContainer.appendChild(item);
                        }

                        // clear form amount
                        addForm.querySelector('input[name="amount"]').value = '';

                        // if server returned remaining_amount, use it to update display
                        if (data.remaining_amount !== undefined && data.remaining_amount !== null){
                            const remEl = document.getElementById('remaining-amount');
                            if (remEl) remEl.textContent = 'Rs. ' + parseFloat(data.remaining_amount).toFixed(2);
                        } else {
                            updateRemaining();
                        }
                    } else {
                        alert('Failed to add payment: ' + (data.message || JSON.stringify(data.errors || data)));
                    }
                })
                .catch(err => {
                    console.error('Add payment failed', err);
                    alert('Failed to add payment. See console.');
                });
            });
        }

        // If payments are edited/deleted via existing handlers, they should call updateRemaining()
        window.updateRemaining = updateRemaining;

    } catch(e){ console.error(e); }
});
</script>
{% endblock %}
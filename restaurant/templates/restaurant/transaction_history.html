{% extends 'restaurant/base.html' %}
{% load static %}

{% block title %}Transaction History{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/transaction_history.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid p-3 p-md-4">
    <h1 class="mb-4 ps-1 ps-md-3">Transaction History</h1>

    <!-- Filters Section -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label small fw-semibold">Start Date</label>
                    <input type="date" id="start-date" class="form-control form-control-sm" value="{{ start_date }}">
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label small fw-semibold">End Date</label>
                    <input type="date" id="end-date" class="form-control form-control-sm" value="{{ end_date }}">
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label small fw-semibold">Order Type</label>
                    <select id="order-type" class="form-select form-select-sm">
                        <option value="" {% if not order_type %}selected{% endif %}>All</option>
                        <option value="table" {% if order_type == 'table' %}selected{% endif %}>Table</option>
                        <option value="takeaway" {% if order_type == 'takeaway' %}selected{% endif %}>Takeaway</option>
                        <option value="delivery" {% if order_type == 'delivery' %}selected{% endif %}>Delivery</option>
                    </select>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label small fw-semibold">Status</label>
                    <select id="status-filter" class="form-select form-select-sm">
                        <option value="" {% if not status %}selected{% endif %}>All</option>
                        <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label small fw-semibold">Search</label>
                    <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Search orders..." value="{{ q }}">
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
        <div class="d-flex align-items-center gap-2">
            <small class="text-secondary">Show</small>
            <select id="entries-select" class="form-select form-select-sm" style="width: auto;">
                <option value="10" {% if entries == '10' %}selected{% endif %}>10</option>
                <option value="50" {% if entries == '50' %}selected{% endif %}>50</option>
                <option value="100" {% if entries == '100' %}selected{% endif %}>100</option>
            </select>
            <small class="text-secondary">entries</small>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <a href="{% url 'restaurant:export_orders_csv' %}{% if params %}?{{ params }}{% endif %}" class="btn btn-success btn-sm" role="button">
                <i class="fas fa-file-excel me-2"></i>Export Excel
            </a>
            <a href="{% url 'restaurant:export_orders_pdf' %}{% if params %}?{{ params }}{% endif %}" class="btn btn-danger btn-sm" role="button">
                <i class="fas fa-file-pdf me-2"></i>Export PDF
            </a>
        </div>
    </div>

    <!-- Main table -->
    <div class="card">
        <div class="table-responsive">
            <table id="orders-table" class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                            <th class="py-2 px-3 align-middle">Order ID</th>
                            <th class="py-2 px-3 align-middle d-none d-sm-table-cell">Customer</th>
                            <th class="py-2 px-3 align-middle">Type</th>
                            <th class="py-2 px-3 align-middle text-end">Amount</th>
                            <th class="py-2 px-3 align-middle d-none d-lg-table-cell">Status</th>
                            <th class="py-2 px-3 align-middle d-none d-md-table-cell">Completed By</th>
                            <th class="py-2 px-3 align-middle text-center">Actions</th>
                        </tr>
                </thead>
                <tbody>
                {% for order in orders %}
                <tr class="order-row" data-order-type="{{ order.order_type }}">
                    <td class="py-2 px-3 border-bottom align-middle">{{ order.order_id }}</td>
                    <td class="py-2 px-3 border-bottom align-middle d-none d-sm-table-cell">{{ order.customer_name }}</td>
                    <td class="py-2 px-3 border-bottom align-middle">
                        {% if order.table %}
                            table #{{ order.table.number }}
                        {% elif order.order_type == 'takeaway' %}
                            Takeaway
                        {% elif order.order_type == 'delivery' %}
                            Delivery
                        {% endif %}
                    </td>
                    <td class="py-2 px-3 border-bottom align-middle text-end">
                        {% if order.order_type == 'delivery' %}
                            Rs.{{ order.total_amount|add:order.delivery_charge }}
                        {% else %}
                            Rs.{{ order.total_amount }}
                        {% endif %}
                    </td>
                    <td class="py-2 px-3 border-bottom align-middle d-none d-lg-table-cell">{{ order.status }}</td>
                    <td class="py-2 px-3 border-bottom align-middle d-none d-md-table-cell">
                        {% if order.completed_by %}
                            {{ order.completed_by.get_full_name|default:order.completed_by.username }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td class="py-2 px-3 border-bottom align-middle text-center">
                        <button data-order-id="{{ order.order_id }}" 
                            data-order-url="{% url 'restaurant:order_history_details' order.order_id %}"
                            class="btn btn-primary btn-sm order-details-btn">
                            View Details
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>




            <!-- Pagination -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3 p-3 border-top">
                <small class="text-secondary">
                    Showing <strong>{{ orders.start_index }}</strong> to <strong>{{ orders.end_index }}</strong> of <strong>{{ orders.paginator.count }}</strong> entries
                </small>
                
                <nav aria-label="Page navigation" class="d-flex justify-content-center">
                    <ul class="pagination pagination-sm mb-0">
                        {% if orders.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if params %}&{{ params }}{% endif %}" aria-label="First">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ orders.previous_page_number }}{% if params %}&{{ params }}{% endif %}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&laquo;&laquo;</span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">&laquo;</span>
                            </li>
                        {% endif %}
                        
                        {% for num in orders.paginator.page_range %}
                            {% if num == orders.number %}
                                <li class="page-item active">
                                    <span class="page-link">
                                        {{ num }}
                                        <span class="visually-hidden">(current)</span>
                                    </span>
                                </li>
                            {% elif num > orders.number|add:'-3' and num < orders.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if params %}&{{ params }}{% endif %}">{{ num }}</a>
                                </li>
                            {% elif num == 1 or num == orders.paginator.num_pages %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if params %}&{{ params }}{% endif %}">{{ num }}</a>
                                </li>
                            {% elif num == 2 or num == orders.paginator.num_pages|add:'-1' %}
                                {% if forloop.first or forloop.last %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if orders.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ orders.next_page_number }}{% if params %}&{{ params }}{% endif %}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ orders.paginator.num_pages }}{% if params %}&{{ params }}{% endif %}" aria-label="Last">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&raquo;</span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">&raquo;&raquo;</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>



    </div>
</div>

<!-- Order Details Modal -->
<div id="order-details-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="order-details-title" tabindex="-1">
        <div class="modal-header">
            <h2 id="order-details-title" class="h3 fw-bold">Order Details</h2>
            <div class="d-flex align-items-center gap-2">
                <button id="modal-close-btn" type="button" onclick="closeModal()" class="modal-close" aria-label="Close dialog">
                    <svg style="width: 1.5rem; height: 1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div id="modal-spinner" class="modal-spinner" aria-hidden="true">
            <div class="spinner"></div>
        </div>
        <!-- Lightweight skeleton loader for perceived performance -->
        <div id="modal-skeleton" class="modal-skeleton" aria-hidden="true">
            <div class="skeleton-row title"></div>
            <div class="skeleton-row meta"></div>
            <div class="skeleton-row items"></div>
            <div class="skeleton-row footer"></div>
        </div>
        <div id="modal-error" class="text-danger small mt-2" style="display:none;"></div>

        <div id="modal-content" class="modal-body">
            <!-- Basic Information -->
            <div class="border-bottom pb-4 mb-3">
                <h3 class="fw-bold h5 mb-2">Basic Information</h3>
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <p class="text-secondary small">Order ID:</p>
                        <p id="modal-order-id" class="fw-semibold"></p>
                    </div>
                    <div class="col-12 col-md-6">
                        <p class="text-secondary small">Customer Name:</p>
                        <p id="modal-customer-name" class="fw-semibold"></p>
                    </div>
                    <div class="col-12 col-md-6">
                        <p class="text-secondary small">Phone:</p>
                        <p id="modal-customer-phone" class="fw-semibold"></p>
                    </div>
                    <div class="col-12 col-md-6">
                        <p class="text-secondary small">Order Type:</p>
                        <p id="modal-order-type" class="fw-semibold"></p>
                    </div>
                    <div class="col-12 col-md-6">
                        <p class="text-secondary small">Completed By:</p>
                        <p id="modal-completed-by" class="fw-semibold"></p>
                    </div>
                    <div class="col-12 col-md-6">
                        <p class="text-secondary small">Subtotal:</p>
                        <p id="modal-total-amount" class="fw-semibold"></p>
                    </div>
                    <div class="col-12 col-md-6" id="modal-delivery-charge-container" style="display: none;">
                        <p class="text-secondary small">Delivery Charge:</p>
                        <p id="modal-delivery-charge" class="fw-semibold"></p>
                    </div>
                    <div class="col-12 col-md-6" id="modal-total-with-delivery-container" style="display: none;">
                        <p class="text-secondary small">Total Amount:</p>
                        <p id="modal-total-with-delivery" class="fw-semibold text-success"></p>
                    </div>
                    <div class="col-12" id="modal-cancellation-reason-container" style="display: none;">
                        <p class="text-secondary small">Cancellation Reason:</p>
                        <p id="modal-cancellation-reason" class="fw-semibold text-danger"></p>
                    </div>
                </div>

                <!-- Payments -->
                <div class="border-bottom pb-4 mb-3">
                    <h3 class="fw-bold h5 mb-2">Payments</h3>
                    <div id="modal-payment-methods" class="d-flex flex-column gap-2 small text-muted"></div>
                </div>

                <!-- Items -->
                <div class="border-bottom pb-4 mb-3">
                    <h3 class="fw-bold h5 mb-2">Items</h3>
                    <div id="modal-order-items" class="modal-order-items d-flex flex-column gap-2"></div>
                </div>

                <!-- Notes update form (AJAX) -->
                <div class="pt-3">
                    <form id="modal-notes-form" class="needs-validation" novalidate>
                        <div class="mb-2">
                            <label for="modal-notes-input" class="form-label small fw-semibold">Update Notes</label>
                            <textarea id="modal-notes-input" class="form-control form-control-sm" rows="2" placeholder="Add or update special notes"></textarea>
                            <div id="modal-notes-error" class="text-danger small mt-1" style="display:none;">Please enter notes before saving.</div>
                            <div id="modal-notes-success" class="text-success small mt-1" style="display:none;">Saved.</div>
                        </div>
                        <div>
                            <button id="modal-notes-save" type="submit" class="btn btn-primary btn-sm">Save Notes</button>
                        </div>
                    </form>
                </div>

                <!-- Dates & Notes -->
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <p class="text-secondary small">Created At:</p>
                        <p id="modal-created-date" class="fw-semibold"></p>
                    </div>
                    <div class="col-12 col-md-6">
                        <p class="text-secondary small">Completed At:</p>
                        <p id="modal-completed-date" class="fw-semibold"></p>
                    </div>
                    <div class="col-12">
                        <p class="text-secondary small">Status History:</p>
                        <div id="modal-status-logs" class="fw-semibold small text-muted"></div>
                    </div>
                    <div class="col-12">
                        <p class="text-secondary small">Special Notes:</p>
                        <p id="modal-special-notes" class="fw-semibold"></p>
                    </div>
                </div>

                <!-- Order Actions removed -->
            </div>
    </div>
</div>



{% comment %} CSS moved to restaurant/static/css/transaction_history.css {% endcomment %}

{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/transaction_history_modal.js' %}"></script>
    <script src="{% static 'js/transaction_history_filters.js' %}"></script>
    <script src="{% static 'js/transaction_history_notes.js' %}"></script>
{% endblock %}

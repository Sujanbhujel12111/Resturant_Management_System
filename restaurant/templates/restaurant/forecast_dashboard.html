{% extends 'restaurant/base.html' %}
{% load static %}

{% block title %}Demand Forecasting - ARIMA{% endblock %}

{% block content %}
<style>
    .forecast-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .forecast-header {
        margin-bottom: 2rem;
    }
    
    .forecast-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1a1a1a;
        margin: 0 0 0.5rem 0;
    }
    
    .controls-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .control-group {
        display: flex;
        flex-direction: column;
    }
    
    .control-group label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .control-group select,
    .control-group input {
        padding: 0.5rem 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    
    .control-group select:focus,
    .control-group input:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }
    
    .btn-group {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .btn {
        padding: 0.65rem 1.25rem;
        border-radius: 6px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }
    
    .btn-primary {
        background: #0066cc;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0052a3;
        transform: translateY(-1px);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .results-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .result-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .result-card h3 {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1a1a1a;
        margin: 0 0 1rem 0;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 0.75rem;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 1rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .stat-item {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0066cc;
        margin-top: 0.25rem;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0066cc;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        display: none;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
    }
    
    .success-message {
        display: none;
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
    }
    
    .diagnostics-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .diagnostic-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .diagnostic-table th {
        background: #f8f9fa;
        padding: 0.75rem;
        text-align: left;
        font-weight: 700;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }
    
    .diagnostic-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    .diagnostic-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    @media (max-width: 1024px) {
        .results-section {
            grid-template-columns: 1fr;
        }
        
        .controls-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
    }
</style>

<div class="forecast-container">
    <!-- Header -->
    <div class="forecast-header">
        <h1><i class="fas fa-chart-line"></i> Demand Forecasting</h1>
        <p style="color: #6c757d; margin: 0;">ARIMA time series prediction for restaurant orders</p>
    </div>
    
    <!-- Messages -->
    <div class="success-message" id="successMessage"></div>
    <div class="error-message" id="errorMessage"></div>
    
    <!-- Controls Section -->
    <div class="controls-section">
        <h2 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 700;">Forecast Settings</h2>
        
        <div class="controls-grid">
            <div class="control-group">
                <label for="metricSelect">Metric</label>
                <select id="metricSelect">
                    <option value="total_amount">Revenue (Rs.)</option>
                    <option value="count">Order Count</option>
                    <option value="average_amount">Average Order Value</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="aggregationSelect">Aggregation</label>
                <select id="aggregationSelect">
                    <option value="daily" selected>Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="orderTypeSelect">Order Type</label>
                <select id="orderTypeSelect">
                    <option value="">All Types</option>
                    <option value="delivery">Delivery</option>
                    <option value="takeaway">Takeaway</option>
                    <option value="dine_in">Dine In</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="periodsInput">Forecast Periods</label>
                <input type="number" id="periodsInput" value="30" min="7" max="365">
            </div>
            
            <div class="control-group">
                <label for="daysBackInput">Historical Days</label>
                <input type="number" id="daysBackInput" value="90" min="14" max="365">
            </div>
            
            <div class="control-group">
                <label for="autoArimaCheckbox">
                    <input type="checkbox" id="autoArimaCheckbox" checked> Auto ARIMA
                </label>
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="generateSingleForecast()">
                <i class="fas fa-play"></i> Generate Forecast
            </button>
            <button class="btn btn-secondary" onclick="generateMultiForecast()">
                <i class="fas fa-stream"></i> Multi-Forecast
            </button>
        </div>
    </div>
    
    <!-- Loading -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; color: #6c757d;">Generating forecast...</p>
    </div>
    
    <!-- Results Section -->
    <div class="results-section" id="resultsSection" style="display: none;">
        <!-- Forecast Chart -->
        <div class="result-card">
            <h3>Forecast Chart</h3>
            <div class="chart-container">
                <canvas id="forecastChart"></canvas>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="result-card">
            <h3>Forecast Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Mean</div>
                    <div class="stat-value" id="statMean">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Std Dev</div>
                    <div class="stat-value" id="statStd">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Min</div>
                    <div class="stat-value" id="statMin">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Max</div>
                    <div class="stat-value" id="statMax">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Sum</div>
                    <div class="stat-value" id="statSum">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Trend</div>
                    <div class="stat-value" id="statTrend">-</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Diagnostics Section -->
    <div class="diagnostics-section" id="diagnosticsSection" style="display: none;">
        <h3 style="margin: 0 0 1rem 0;">Model Diagnostics</h3>
        <table class="diagnostic-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>AIC</td>
                    <td id="diagAIC">-</td>
                </tr>
                <tr>
                    <td>BIC</td>
                    <td id="diagBIC">-</td>
                </tr>
                <tr>
                    <td>Log-Likelihood</td>
                    <td id="diagLoglik">-</td>
                </tr>
                <tr>
                    <td>Residuals Mean</td>
                    <td id="diagResMean">-</td>
                </tr>
                <tr>
                    <td>Residuals Std</td>
                    <td id="diagResStd">-</td>
                </tr>
                <tr>
                    <td>Data Points</td>
                    <td id="diagDataPoints">-</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
    let forecastChart = null;
    
    function showMessage(type, text) {
        const id = type === 'success' ? 'successMessage' : 'errorMessage';
        const el = document.getElementById(id);
        el.textContent = text;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }
    
    function showLoading(show = true) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }
    
    function generateSingleForecast() {
        showLoading(true);
        
        const payload = {
            metric: document.getElementById('metricSelect').value,
            aggregation: document.getElementById('aggregationSelect').value,
            order_type: document.getElementById('orderTypeSelect').value || null,
            periods: parseInt(document.getElementById('periodsInput').value),
            days_back: parseInt(document.getElementById('daysBackInput').value),
            use_auto_arima: document.getElementById('autoArimaCheckbox').checked,
        };
        
        fetch('{% url "restaurant:ml:generate_forecast" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify(payload),
        })
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            
            if (data.success) {
                displayForecast(data);
                showMessage('success', 'Forecast generated successfully!');
            } else {
                showMessage('error', data.error || 'Failed to generate forecast');
            }
        })
        .catch(error => {
            showLoading(false);
            console.error('Error:', error);
            showMessage('error', 'Error generating forecast');
        });
    }
    
    function generateMultiForecast() {
        showLoading(true);
        
        const payload = {
            aggregation: document.getElementById('aggregationSelect').value,
            periods: parseInt(document.getElementById('periodsInput').value),
            days_back: parseInt(document.getElementById('daysBackInput').value),
            use_auto_arima: document.getElementById('autoArimaCheckbox').checked,
        };
        
        fetch('{% url "restaurant:ml:multi_forecast" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify(payload),
        })
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            
            if (data.success) {
                displayMultiForecast(data);
                showMessage('success', 'Multi-forecast generated successfully!');
            } else {
                showMessage('error', data.error || 'Failed to generate forecast');
            }
        })
        .catch(error => {
            showLoading(false);
            console.error('Error:', error);
            showMessage('error', 'Error generating forecast');
        });
    }
    
    function displayForecast(data) {
        document.getElementById('resultsSection').style.display = 'grid';
        document.getElementById('diagnosticsSection').style.display = 'block';
        
        const forecast = data.forecast;
        const stats = data.statistics;
        const diag = data.diagnostics;
        
        // Format currency/numbers
        const formatValue = (v, decimals = 2) => {
            if (typeof v !== 'number') return '-';
            return v.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };
        
        // Update stats
        document.getElementById('statMean').textContent = formatValue(stats.mean);
        document.getElementById('statStd').textContent = formatValue(stats.std);
        document.getElementById('statMin').textContent = formatValue(stats.min);
        document.getElementById('statMax').textContent = formatValue(stats.max);
        document.getElementById('statSum').textContent = formatValue(stats.sum);
        document.getElementById('statTrend').textContent = (stats.trend || '-').toUpperCase();
        
        // Update diagnostics
        document.getElementById('diagAIC').textContent = formatValue(diag.aic);
        document.getElementById('diagBIC').textContent = formatValue(diag.bic);
        document.getElementById('diagLoglik').textContent = formatValue(diag.loglik);
        document.getElementById('diagResMean').textContent = formatValue(diag.residuals_mean, 6);
        document.getElementById('diagResStd').textContent = formatValue(diag.residuals_std, 6);
        document.getElementById('diagDataPoints').textContent = data.data_points;
        
        // Draw chart
        drawForecastChart(forecast);
    }
    
    function displayMultiForecast(data) {
        const forecasts = data.forecasts;
        alert('Multi-forecast results:\n' + JSON.stringify(forecasts, null, 2));
        // You can enhance this with a table or grid view
    }
    
    function drawForecastChart(forecast) {
        const ctx = document.getElementById('forecastChart').getContext('2d');
        
        const dates = forecast.dates || [];
        const values = forecast.forecast || [];
        const lower = forecast.lower_bound || [];
        const upper = forecast.upper_bound || [];
        
        if (forecastChart) {
            forecastChart.destroy();
        }
        
        forecastChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates.map(d => {
                    const date = new Date(d);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }),
                datasets: [
                    {
                        label: 'Forecast',
                        data: values,
                        borderColor: '#0066cc',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: '#0066cc',
                    },
                    ...(lower.length > 0 ? [{
                        label: '95% Lower Bound',
                        data: lower,
                        borderColor: 'rgba(0, 102, 204, 0.3)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0,
                    }] : []),
                    ...(upper.length > 0 ? [{
                        label: '95% Upper Bound',
                        data: upper,
                        borderColor: 'rgba(0, 102, 204, 0.3)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0,
                    }] : []),
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Value',
                        },
                    },
                },
            },
        });
    }
</script>
{% endblock %}
